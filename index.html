<html>
  <head>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      type="text/css"
      rel="stylesheet"
      href="css/materialize.css"
      media="screen,projection"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script type="text/javascript" src="js/materialize.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <h1>Contract Generator</h1>
      </div>
      <div class="row">
        <h2>Employment Contract</h2>
      </div>
      <div class="row">
        <form class="col s12" action="#" id="employmentForm">
          <div class="row">
            <div class="input-field col s6">
              <input
                type="text"
                name="executionDate"
                id="executionDate"
                class="datepicker"
              />
              <label for="executionDate">Date of Execution</label>
            </div>
          </div>
          <div class="row">
            <h3>Employer</h3>
          </div>
          <div class="row">
            <div class="col s12">
              <label for="isJuridical">
                <input type="checkbox" name="isJuridical" id="isJuridical" />
                <span>Juridical Employer</span>
              </label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s6">
              <input type="text" name="employerName" id="employerName" />
              <label for="employerName">Name of Employer</label>
            </div>
            <div class="input-field col s6">
              <input
                type="text"
                name="representativeName"
                id="representativeName"
              />
              <label for="representativeName">Name of Representative</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12">
              <input type="text" name="employerAddress" id="employerAddress" />
              <label for="employerAddress">Address</label>
            </div>
          </div>
          <div class="row">
            <h3>Employee</h3>
          </div>
          <div class="row">
            <div class="col s6 input-field">
              <input type="text" name="employeeName" id="employeeName" />
              <label for="employeeName">Employee Name</label>
            </div>
            <div class="col s6 input-field">
              <input type="text" name="nationality" id="nationality" />
              <label for="nationality">Nationality</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12">
              <input type="text" name="employeeAddress" id="employeeAddress" />
              <label for="employeeAddress">Address</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s6">
              <input type="text" name="position" id="position" />
              <label for="position">Position</label>
            </div>
            <div class="input-field col s6">
              <input
                type="text"
                class="datepicker"
                name="startDate"
                id="startDate"
              />
              <label for="startDate">Start Date</label>
            </div>
          </div>
          <div class="row">
            <div class="col s6 input-field">
              <input
                type="text"
                name="probationaryPeriod"
                id="probationaryPeriod"
              />
              <label for="probationaryPeriod"
                >Duration of Probation (Leave blank if no probation)</label
              >
            </div>
            <div class="col s6 input-field">
              <input type="text" name="lockinPeriod" id="lockinPeriod" />
              <label for="lockinPeriod"
                >Duration of Lock-in (Leave blank if no lock-in period)</label
              >
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12">
              <input type="text" name="placeOfWork" id="placeOfWork" />
              <label for="placeOfWork"
                >Place of Work (Leave blank if same as employer office)</label
              >
            </div>
          </div>
          <div class="row">
            <div class="input-field col s6">
              <label for="isExclusive">
                <input type="checkbox" name="isExclusive" id="isExclusive" />
                <span>Exclusive</span>
              </label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s6">
              <label for="isConfidential">
                <input
                  type="checkbox"
                  name="isConfidential"
                  id="isConfidential"
                />
                <span>Confidential</span>
              </label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s6">
              <input type="text" name="nonCompete" id="nonCompete" />
              <label for="nonCompete"
                >Duration of non-compete (Leave blank if no non-compte)</label
              >
            </div>
          </div>
          <div class="row">
            <div class="input-field col s6">
              <input
                type="text"
                name="terminationPeriod"
                id="terminationPeriod"
              />
              <label for="terminationPeriod"
                >Period to notify termination</label
              >
            </div>
          </div>
          <div class="row">
            <button
              class="btn waves-effect waves-light right"
              type="submit"
              name="action"
              onclick="generate()"
            >
              Generate Document
              <i class="material-icons right">send</i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </body>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.17.9/docxtemplater.js"></script>
  <script src="https://unpkg.com/pizzip@3.0.6/dist/pizzip.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
  <script src="https://unpkg.com/pizzip@3.0.6/dist/pizzip-utils.js"></script>
  <!--
    Mandatory in IE 6, 7, 8 and 9.
    -->
  <!--[if IE]>
    <script
      type="text/javascript"
      src="https://unpkg.com/pizzip@3.0.6/dist/pizzip-utils-ie.js"
    ></script>
  <![endif]-->
  <script>
    var output = {};
    (function () {
      function toJSONString(form) {
        var obj = {};
        var elements = form.querySelectorAll("input, select, textarea");
        for (var i = 0; i < elements.length; ++i) {
          var element = elements[i];
          var name = element.name;
          var value = String(element.value);
          if (element.type && element.type === "checkbox") {
            if (element.checked) {
              value = true;
            } else {
              value = false;
            }
          }

          if (name) {
            obj[name] = value;
          }
        }

        return JSON.stringify(obj);
      }

      document.addEventListener("DOMContentLoaded", function () {
        var form = document.getElementById("employmentForm");
        form.addEventListener(
          "submit",
          function (e) {
            e.preventDefault();
            var json = toJSONString(this);
            output = json;
          },
          false
        );
      });
    })();
    M.AutoInit();

    function loadFile(url, callback) {
      PizZipUtils.getBinaryContent(url, callback);
    }
    function generate() {
      loadFile("contract_templates/Employment Agreement.docx", function (
        error,
        content
      ) {
        if (error) {
          throw error;
        }

        // The error object contains additional information when logged with JSON.stringify (it contains a properties object containing all suberrors).
        function replaceErrors(key, value) {
          if (value instanceof Error) {
            return Object.getOwnPropertyNames(value).reduce(function (
              error,
              key
            ) {
              error[key] = value[key];
              return error;
            },
            {});
          }
          return value;
        }

        function errorHandler(error) {
          console.log(JSON.stringify({ error: error }, replaceErrors));

          if (error.properties && error.properties.errors instanceof Array) {
            const errorMessages = error.properties.errors
              .map(function (error) {
                return error.properties.explanation;
              })
              .join("\n");
            console.log("errorMessages", errorMessages);
            // errorMessages is a humanly readable message looking like this :
            // 'The tag beginning with "foobar" is unopened'
          }
          throw error;
        }

        var zip = new PizZip(content);
        var doc;
        try {
          doc = new window.docxtemplater(zip);
        } catch (error) {
          // Catch compilation errors (errors caused by the compilation of the template : misplaced tags)
          errorHandler(error);
        }

        console.log("output is: " + output);
        doc.setData(JSON.parse(output));
        try {
          doc.render();
        } catch (error) {
          // Catch rendering errors (errors relating to the rendering of the template : angularParser throws an error)
          errorHandler(error);
        }

        var out = doc.getZip().generate({
          type: "blob",
          mimeType:
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        }); //Output the document using Data-URI
        var JSONoutput = JSON.parse(output);
        console.log(JSONoutput.employeeName);
        var documentTitle =
          JSONoutput.employeeName +
          " - " +
          JSONoutput.employerName +
          " Employment Agreement.docx";
        saveAs(out, documentTitle);
      });
    }
  </script>
</html>
